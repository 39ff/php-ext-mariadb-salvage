name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # Linux .so builds
  # ---------------------------------------------------------------------------
  build-linux:
    name: Linux - PHP ${{ matrix.php }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['7.4', '8.0', '8.1', '8.2', '8.3', '8.4']

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mysqlnd
          tools: phpize
          ini-values: error_reporting=E_ALL

      - name: Build extension
        working-directory: ext/mariadb_profiler
        run: |
          phpize
          ./configure --enable-mariadb_profiler
          make -j$(nproc)

      - name: Verify extension is loadable
        working-directory: ext/mariadb_profiler
        run: |
          php -d "extension=$(pwd)/modules/mariadb_profiler.so" -m | grep mariadb_profiler

      - name: Package artifact
        run: |
          mkdir -p dist
          cp ext/mariadb_profiler/modules/mariadb_profiler.so \
            "dist/mariadb_profiler-php${{ matrix.php }}-linux-x86_64.so"

      - uses: actions/upload-artifact@v4
        with:
          name: mariadb_profiler-php${{ matrix.php }}-linux-x86_64
          path: dist/*.so

  # ---------------------------------------------------------------------------
  # Windows .dll builds
  # ---------------------------------------------------------------------------
  build-windows:
    name: Windows - PHP ${{ matrix.php }} ${{ matrix.ts }} ${{ matrix.arch }}
    runs-on: windows-${{ matrix.os }}
    defaults:
      run:
        shell: cmd
    strategy:
      fail-fast: false
      matrix:
        php: ['7.4', '8.0', '8.1', '8.2', '8.3', '8.4']
        arch: [x64]
        ts: [nts, ts]
        os: ['2022']
        include:
          # PHP 7.4 requires VC15 (v141 toolset, MSVC 14.1x).
          # PHP 8.0-8.3 use VS16, PHP 8.4 uses VS17.
          # windows-2022 runners have vs16/vs17 but NOT vc15,
          # so we install the v141 component for PHP 7.4.
          - php: '7.4'
            vs: vs16
          - php: '8.0'
            vs: vs16
          - php: '8.1'
            vs: vs16
          - php: '8.2'
            vs: vs16
          - php: '8.3'
            vs: vs16
          - php: '8.4'
            vs: vs17

    steps:
      - uses: actions/checkout@v4

      - name: Install VC15 (v141) toolset for PHP 7.4
        if: matrix.php == '7.4'
        shell: pwsh
        run: |
          Set-Location "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
          $installPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
          $component = "Microsoft.VisualStudio.Component.VC.v141.x86.x64"
          $args = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$installPath`"",
                   '--add', $component, '--quiet', '--norestart', '--nocache')
          $process = Start-Process -FilePath cmd.exe -ArgumentList $args -Wait -PassThru -WindowStyle Hidden
          if ($process.ExitCode -ne 0) {
            Write-Warning "vs_installer exited with code $($process.ExitCode)"
          }

      - name: Setup PHP SDK
        id: setup
        uses: php/setup-php-sdk@v0.12
        with:
          version: ${{ matrix.php }}
          arch: ${{ matrix.arch }}
          ts: ${{ matrix.ts }}

      - name: Enable MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}
          toolset: ${{ steps.setup.outputs.toolset }}

      - name: phpize
        working-directory: ext\mariadb_profiler
        run: phpize

      - name: configure
        working-directory: ext\mariadb_profiler
        run: configure --enable-mariadb_profiler --with-prefix=%INSTALL_DIR%

      - name: nmake
        working-directory: ext\mariadb_profiler
        run: nmake

      - name: Package artifact
        shell: pwsh
        run: |
          $ts = "${{ matrix.ts }}"
          $arch = "${{ matrix.arch }}"
          $phpVer = "${{ matrix.php }}"

          # Find the built DLL
          $dll = Get-ChildItem -Path ext\mariadb_profiler -Recurse -Filter "php_mariadb_profiler.dll" |
                 Select-Object -First 1
          if (-not $dll) {
            Write-Error "php_mariadb_profiler.dll not found"
            exit 1
          }
          Write-Host "Found DLL: $($dll.FullName)"

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $name = "php_mariadb_profiler-php${phpVer}-${ts}-${arch}"
          Copy-Item $dll.FullName "dist\${name}.dll"
          Write-Host "Packaged as: dist\${name}.dll"

      - uses: actions/upload-artifact@v4
        with:
          name: php_mariadb_profiler-php${{ matrix.php }}-${{ matrix.ts }}-${{ matrix.arch }}
          path: dist\*.dll

  # ---------------------------------------------------------------------------
  # JetBrains Plugin build
  # ---------------------------------------------------------------------------
  build-plugin:
    name: JetBrains Plugin
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run tests
        working-directory: jetbrains-plugin
        run: ./gradlew test

      - name: Build plugin
        working-directory: jetbrains-plugin
        run: ./gradlew buildPlugin

      - uses: actions/upload-artifact@v4
        with:
          name: mariadb-profiler-viewer-plugin
          path: jetbrains-plugin/build/distributions/*.zip
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # Create GitHub Release
  # ---------------------------------------------------------------------------
  release:
    name: Create Release
    needs: [build-linux, build-windows, build-plugin]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.so" -o -name "*.dll" -o -name "*.zip" \) -exec cp {} release/ \;
          echo "=== Release assets ==="
          ls -lh release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release/*
